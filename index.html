<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elm Type Definitions</title>
    <link rel="stylesheet" href="./assets/codemirror/main.css" />
    <link rel="stylesheet" href="./assets/style.css" />
  </head>
  <body>
    <script id="elm-d-ts" type="x-noparse-text/typescript">
      declare namespace Elm {
        type IncomingPorts<T> = {
          [P in keyof T]: {
            send(message: T[P]): void;
          };
        };

        type OutgoingPorts<T> = {
          [P in keyof T]: {
            subscribe(handler: (message: T[P]) => void): void;
            unsubscribe(handler: (message: T[P]) => void): void;
          };
        };

        type Flags<T extends Init> = T extends Init<infer F> ? F : never;

        type Ports<T extends Init> = T extends Init<any, infer In, infer Out>
          ? IncomingPorts<In> & OutgoingPorts<Out>
          : never;

        type Init<Flags = void, In = {}, Out = {}> = (Flags extends void
          ? {}
          : { flags: Flags }) &
          (keyof (IncomingPorts<In> & OutgoingPorts<Out>) extends never
            ? {}
            : {
                ports: (keyof In extends never ? {} : { incoming: In }) &
                  (keyof Out extends never ? {} : { outgoing: Out });
              });

        type App<Ports> = keyof Ports extends never ? {} : { ports: Ports };

        type Module = {
          init<T extends Init>(
            options: { node: HTMLElement } & (Flags<T> extends void
              ? {}
              : { flags: Flags<T> })
          ): App<Ports<T>>;
        };
      }

      declare var Elm: {
        [module: string]: Elm.Module | undefined;
      };
    </script>
    <script id="main-ts" type="x-noparse-text/typescript">
      (() => {
        type ElmInit = {
          flags: {
            title: string;
            sourceFiles: { name: string; content: string }[];
          };
          ports: {
            incoming: {
              localStorageGetResp: { value: string };
            };
            outgoing: {
              localStorageGetReq: { key: string };
              localStorageSet: { key: string; value: string };
              localStorageClear: null;
            };
          };
        };

        let elmDiv = document.createElement("div");
        document.body.appendChild(elmDiv);

        let sourceFiles = ["elm.d.ts", "main.ts"].map(name => {
          let elementId = name.replace(/\./g, "-");
          let content = readEmbeddedSourceCode(elementId);
          return { name, content };
        });

        let app = Elm.Main!.init<ElmInit>({
          node: elmDiv,
          flags: { title: "Elm Type Definitions", sourceFiles }
        });

        app.ports.localStorageGetReq.subscribe(({ key }) => {
          app.ports.localStorageGetResp.send({
            value: localStorage.getItem(key) || ""
          });
        });

        app.ports.localStorageSet.subscribe(({ key, value }) => {
          localStorage.setItem(key, value);
        });

        app.ports.localStorageClear.subscribe(() => {
          localStorage.clear();
        });

        function readEmbeddedSourceCode(elementId: string) {
          let scriptElement = document.getElementById(elementId);
          if (!scriptElement) {
            throw new Error(`Could not find script tag #${elementId}.`);
          }
          let lines = scriptElement.textContent!.split("\n").slice(1);
          let indent = lines[0].search(/[^\s]/);
          return lines.map(l => l.slice(indent)).join("\n");
        }
      })();
    </script>
    <script src="./assets/codemirror/main.js"></script>
    <script src="./assets/codemirror/javascript.js"></script>
    <script src="./dist/elm.js"></script>
    <script src="./dist/CodeViewer.js"></script>
    <script src="./dist/main.js"></script>
  </body>
</html>
